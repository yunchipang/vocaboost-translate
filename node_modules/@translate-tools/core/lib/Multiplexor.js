"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Multiplexor = void 0;
/**
 * Util for pack multiple requests to one
 *
 * It's just encode/decode all texts with custom separation options
 */
var Multiplexor = /** @class */function () {
  // private readonly token: Array<Array<string>> = [];
  function Multiplexor(options) {
    this.options = {
      tokenStart: '<',
      tokenEnd: '>',
      tokenClose: '/'
    };
    if (options !== undefined) {
      ['tokenStart', 'tokenEnd', 'tokenClose'].forEach(function (key) {
        var item = options[key];
        if (item !== undefined && item.search(/\&|\:/) !== -1) {
          throw new Error("Option ".concat(key, " has disallow characters (& or :)"));
        }
      });
      for (var key in options) {
        this.options[key] = options[key];
      }
    }
  }
  Multiplexor.prototype.encode = function (data) {
    var _this = this;
    var _a = this.options,
      _b = _a.tokenStart,
      start = _b === void 0 ? '' : _b,
      _c = _a.tokenEnd,
      end = _c === void 0 ? '' : _c,
      _d = _a.tokenClose,
      close = _d === void 0 ? '' : _d;
    return data.map(function (_a) {
      var id = _a.id,
        text = _a.text;
      return start + id + end + _this.escape(text) + start + close + id + end;
    }).join(' ');
  };
  Multiplexor.prototype.decode = function (text) {
    var _a = this.options,
      _b = _a.tokenStart,
      start = _b === void 0 ? '' : _b,
      _c = _a.tokenEnd,
      end = _c === void 0 ? '' : _c,
      _d = _a.tokenClose,
      close = _d === void 0 ? '' : _d;
    var pattern = "".concat(start, "\\s*(\\d+)\\s*").concat(end, "([\\w\\W]+?)").concat(start, "\\s*").concat(close, "\\s*\\1\\s*").concat(end);
    var matchSet = text.matchAll(new RegExp(pattern, 'gm'));
    var result = [];
    var match = matchSet.next();
    while (!match.done) {
      result.push({
        id: match.value[1],
        text: this.unescape(match.value[2])
      });
      match = matchSet.next();
    }
    return result;
  };
  Multiplexor.prototype.escape = function (text) {
    var _this = this;
    ['tokenStart', 'tokenEnd', 'tokenClose'].forEach(function (key, index) {
      var token = _this.options[key];
      if (token.length > 0) {
        text = text.replace(new RegExp(_this.escapeRegExp(token), 'g'), "&".concat(index + 1, ":"));
      }
    });
    return text;
  };
  Multiplexor.prototype.unescape = function (text) {
    var _this = this;
    ['tokenStart', 'tokenEnd', 'tokenClose'].forEach(function (key, index) {
      var token = _this.options[key];
      if (token.length > 0) {
        text = text.replace(new RegExp("&".concat(index + 1, ":"), 'g'), token);
      }
    });
    return text;
  };
  Multiplexor.prototype.escapeRegExp = function (text) {
    return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
  };
  return Multiplexor;
}();
exports.Multiplexor = Multiplexor;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL011bHRpcGxleG9yLmpzIiwibmFtZXMiOlsiTXVsdGlwbGV4b3IiLCJvcHRpb25zIiwidG9rZW5TdGFydCIsInRva2VuRW5kIiwidG9rZW5DbG9zZSIsInVuZGVmaW5lZCIsImZvckVhY2giLCJrZXkiLCJpdGVtIiwic2VhcmNoIiwiRXJyb3IiLCJjb25jYXQiLCJwcm90b3R5cGUiLCJlbmNvZGUiLCJkYXRhIiwiX3RoaXMiLCJfYSIsIl9iIiwic3RhcnQiLCJfYyIsImVuZCIsIl9kIiwiY2xvc2UiLCJtYXAiLCJpZCIsInRleHQiLCJlc2NhcGUiLCJqb2luIiwiZGVjb2RlIiwicGF0dGVybiIsIm1hdGNoU2V0IiwibWF0Y2hBbGwiLCJSZWdFeHAiLCJyZXN1bHQiLCJtYXRjaCIsIm5leHQiLCJkb25lIiwicHVzaCIsInZhbHVlIiwidW5lc2NhcGUiLCJpbmRleCIsInRva2VuIiwibGVuZ3RoIiwicmVwbGFjZSIsImVzY2FwZVJlZ0V4cCIsImV4cG9ydHMiXSwic291cmNlcyI6WyJsaWIvTXVsdGlwbGV4b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW50ZXJmYWNlIE9wdGlvbnMge1xuXHR0b2tlblN0YXJ0Pzogc3RyaW5nO1xuXHR0b2tlbkVuZD86IHN0cmluZztcblx0dG9rZW5DbG9zZT86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIFRleHRDb250YWluZXIge1xuXHRpZDogc3RyaW5nO1xuXHR0ZXh0OiBzdHJpbmc7XG59XG5cbi8qKlxuICogVXRpbCBmb3IgcGFjayBtdWx0aXBsZSByZXF1ZXN0cyB0byBvbmVcbiAqXG4gKiBJdCdzIGp1c3QgZW5jb2RlL2RlY29kZSBhbGwgdGV4dHMgd2l0aCBjdXN0b20gc2VwYXJhdGlvbiBvcHRpb25zXG4gKi9cbmV4cG9ydCBjbGFzcyBNdWx0aXBsZXhvciB7XG5cdHByaXZhdGUgcmVhZG9ubHkgb3B0aW9uczogT3B0aW9ucyA9IHtcblx0XHR0b2tlblN0YXJ0OiAnPCcsXG5cdFx0dG9rZW5FbmQ6ICc+Jyxcblx0XHR0b2tlbkNsb3NlOiAnLycsXG5cdH07XG5cblx0Ly8gcHJpdmF0ZSByZWFkb25seSB0b2tlbjogQXJyYXk8QXJyYXk8c3RyaW5nPj4gPSBbXTtcblx0Y29uc3RydWN0b3Iob3B0aW9ucz86IE9wdGlvbnMpIHtcblx0XHRpZiAob3B0aW9ucyAhPT0gdW5kZWZpbmVkKSB7XG5cdFx0XHRbJ3Rva2VuU3RhcnQnLCAndG9rZW5FbmQnLCAndG9rZW5DbG9zZSddLmZvckVhY2goKGtleSkgPT4ge1xuXHRcdFx0XHRjb25zdCBpdGVtID0gKG9wdGlvbnMgYXMgYW55KVtrZXldO1xuXHRcdFx0XHRpZiAoaXRlbSAhPT0gdW5kZWZpbmVkICYmIGl0ZW0uc2VhcmNoKC9cXCZ8XFw6LykgIT09IC0xKSB7XG5cdFx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJHtrZXl9IGhhcyBkaXNhbGxvdyBjaGFyYWN0ZXJzICgmIG9yIDopYCk7XG5cdFx0XHRcdH1cblx0XHRcdH0pO1xuXG5cdFx0XHRmb3IgKGNvbnN0IGtleSBpbiBvcHRpb25zKSB7XG5cdFx0XHRcdCh0aGlzLm9wdGlvbnMgYXMgYW55KVtrZXldID0gKG9wdGlvbnMgYXMgYW55KVtrZXldO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHB1YmxpYyBlbmNvZGUoZGF0YTogVGV4dENvbnRhaW5lcltdKSB7XG5cdFx0Y29uc3Qge1xuXHRcdFx0dG9rZW5TdGFydDogc3RhcnQgPSAnJyxcblx0XHRcdHRva2VuRW5kOiBlbmQgPSAnJyxcblx0XHRcdHRva2VuQ2xvc2U6IGNsb3NlID0gJycsXG5cdFx0fSA9IHRoaXMub3B0aW9ucztcblxuXHRcdHJldHVybiBkYXRhXG5cdFx0XHQubWFwKFxuXHRcdFx0XHQoeyBpZCwgdGV4dCB9KSA9PlxuXHRcdFx0XHRcdHN0YXJ0ICsgaWQgKyBlbmQgKyB0aGlzLmVzY2FwZSh0ZXh0KSArIHN0YXJ0ICsgY2xvc2UgKyBpZCArIGVuZCxcblx0XHRcdClcblx0XHRcdC5qb2luKCcgJyk7XG5cdH1cblxuXHRwdWJsaWMgZGVjb2RlKHRleHQ6IHN0cmluZykge1xuXHRcdGNvbnN0IHtcblx0XHRcdHRva2VuU3RhcnQ6IHN0YXJ0ID0gJycsXG5cdFx0XHR0b2tlbkVuZDogZW5kID0gJycsXG5cdFx0XHR0b2tlbkNsb3NlOiBjbG9zZSA9ICcnLFxuXHRcdH0gPSB0aGlzLm9wdGlvbnM7XG5cblx0XHRjb25zdCBwYXR0ZXJuID0gYCR7c3RhcnR9XFxcXHMqKFxcXFxkKylcXFxccyoke2VuZH0oW1xcXFx3XFxcXFddKz8pJHtzdGFydH1cXFxccyoke2Nsb3NlfVxcXFxzKlxcXFwxXFxcXHMqJHtlbmR9YDtcblx0XHRjb25zdCBtYXRjaFNldCA9IHRleHQubWF0Y2hBbGwobmV3IFJlZ0V4cChwYXR0ZXJuLCAnZ20nKSk7XG5cblx0XHRjb25zdCByZXN1bHQgPSBbXTtcblx0XHRsZXQgbWF0Y2ggPSBtYXRjaFNldC5uZXh0KCk7XG5cdFx0d2hpbGUgKCFtYXRjaC5kb25lKSB7XG5cdFx0XHRyZXN1bHQucHVzaCh7XG5cdFx0XHRcdGlkOiBtYXRjaC52YWx1ZVsxXSxcblx0XHRcdFx0dGV4dDogdGhpcy51bmVzY2FwZShtYXRjaC52YWx1ZVsyXSksXG5cdFx0XHR9KTtcblx0XHRcdG1hdGNoID0gbWF0Y2hTZXQubmV4dCgpO1xuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cblxuXHRwcml2YXRlIGVzY2FwZSh0ZXh0OiBzdHJpbmcpIHtcblx0XHRbJ3Rva2VuU3RhcnQnLCAndG9rZW5FbmQnLCAndG9rZW5DbG9zZSddLmZvckVhY2goKGtleSwgaW5kZXgpID0+IHtcblx0XHRcdGNvbnN0IHRva2VuID0gKHRoaXMub3B0aW9ucyBhcyBhbnkpW2tleV07XG5cdFx0XHRpZiAodG9rZW4ubGVuZ3RoID4gMCkge1xuXHRcdFx0XHR0ZXh0ID0gdGV4dC5yZXBsYWNlKFxuXHRcdFx0XHRcdG5ldyBSZWdFeHAodGhpcy5lc2NhcGVSZWdFeHAodG9rZW4pLCAnZycpLFxuXHRcdFx0XHRcdGAmJHtpbmRleCArIDF9OmAsXG5cdFx0XHRcdCk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cblx0XHRyZXR1cm4gdGV4dDtcblx0fVxuXG5cdHByaXZhdGUgdW5lc2NhcGUodGV4dDogc3RyaW5nKSB7XG5cdFx0Wyd0b2tlblN0YXJ0JywgJ3Rva2VuRW5kJywgJ3Rva2VuQ2xvc2UnXS5mb3JFYWNoKChrZXksIGluZGV4KSA9PiB7XG5cdFx0XHRjb25zdCB0b2tlbiA9ICh0aGlzLm9wdGlvbnMgYXMgYW55KVtrZXldO1xuXHRcdFx0aWYgKHRva2VuLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0dGV4dCA9IHRleHQucmVwbGFjZShuZXcgUmVnRXhwKGAmJHtpbmRleCArIDF9OmAsICdnJyksIHRva2VuKTtcblx0XHRcdH1cblx0XHR9KTtcblxuXHRcdHJldHVybiB0ZXh0O1xuXHR9XG5cblx0cHJpdmF0ZSBlc2NhcGVSZWdFeHAodGV4dDogc3RyaW5nKSB7XG5cdFx0cmV0dXJuIHRleHQucmVwbGFjZSgvWy1bXFxde30oKSorPy4sXFxcXF4kfCNcXHNdL2csICdcXFxcJCYnKTtcblx0fVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFXQTs7Ozs7QUFLQSxJQUFBQSxXQUFBO0VBT0M7RUFDQSxTQUFBQSxZQUFZQyxPQUFpQjtJQVBaLEtBQUFBLE9BQU8sR0FBWTtNQUNuQ0MsVUFBVSxFQUFFLEdBQUc7TUFDZkMsUUFBUSxFQUFFLEdBQUc7TUFDYkMsVUFBVSxFQUFFO0tBQ1o7SUFJQSxJQUFJSCxPQUFPLEtBQUtJLFNBQVMsRUFBRTtNQUMxQixDQUFDLFlBQVksRUFBRSxVQUFVLEVBQUUsWUFBWSxDQUFDLENBQUNDLE9BQU8sQ0FBQyxVQUFDQyxHQUFHO1FBQ3BELElBQU1DLElBQUksR0FBSVAsT0FBZSxDQUFDTSxHQUFHLENBQUM7UUFDbEMsSUFBSUMsSUFBSSxLQUFLSCxTQUFTLElBQUlHLElBQUksQ0FBQ0MsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFO1VBQ3RELE1BQU0sSUFBSUMsS0FBSyxDQUFDLFVBQUFD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
